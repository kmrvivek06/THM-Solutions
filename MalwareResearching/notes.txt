We can expect to learn about file checksums, why these values are important in not only day-to-day life but more so how we can utilise them in malware analysis. The first few tasks are theory-heavy, so bear with me. However, towards the end of the room, you will be generating your own checksums, learning how to use online sandboxing, and analysing the reports generated from these.

CHEKSUM 101:
	Checksums are a prominent attribute within the malware analysis community. But moreover, the wider Information Technology (IT) industry. Put simply, these checksums are the result of mathematical operations against an input - where the output is a sequence of characters.

Ultimately, the markup of data on a computer system is binary, merely ones and zeros where each value is a "bit". A cryptographic checksum uses these "bits" as the input for these mathematical operations; the increased complexity of the mathematical operations applied, the more secure a checksum is considered. These checksums are also commonly referred to as "hashes".

Because of how cryptographic algorithms work, regardless of the size of the input - such as a file - the length of the output will remain the same. For example, take an algorithm and apply these mathematical operations against two files listed below:


File Name	File Size
My_Video.mp4	4GB
My_Selfie.png	10MB


Although the file size is vastly different, the length of the output calculated will be the same, albeit its contents different. For example, in this algorithm I have as an example, the output length is 12 characters:


File Name	File Size	The output from the Algorithm
My_Video.mp4	4GB		3DEFAD92D23AD
My_Selfie.png	10MB		FFDE312DAEFF

Whilst the values calculated from the algorithm are different from each file, they remain the same length - irrespective of the file size. Because the two files have different contents, in this case, each output is unique for the file.

The increased complexity of the mathematical operations vastly reduces the chances of two files with different contents from having the same output. If this was to occur, it is known as a "hash collision". Explaining the math behind how this happens is out of scope, however, it is extremely rare. To put into perspective, the hashing algorithm MD5 which is a famous recent example will need 6 billion files to be hashed per second - for 100 years on average. (Kornel., 2008)

More on MD5:
	https://stackoverflow.com/questions/201705/how-many-random-elements-before-md5-produces-collisions
	https://stackoverflow.com/users/27009/kornel

Whilst it's pretty safe to say that the probability of a hash collision occurring is pretty low, it is mathematically possible. For example, researchers (Stevens et al., 2017) report on Shattered.io, where they were able to demonstrate a SHA1 hash collision in practice. I greatly encourage taking the time to read through the report to understand how these collisions can be made into proof of concepts but to also appreciate why discoveries like this are important in the world of information security.

Report link:
	https://shattered.io/static/shattered.pdf
	
It's safe to say it's pretty rare for this error to happen, although it is mathematically possible. We'll visualise this below.

Let's contextualise checksums a bit more. In IT, checksums are used for verifying the integrity of data. Have you ever copied a file onto a USB drive where Windows complains that the file is now corrupt? That is data corruption; binary data was lost somewhere during the transfer process, either due to software or hardware error.

Due to how these cryptographic algorithms work, namely, they produce a result after processing a piece of data at every single bit, checksums are fantastic for verifying if data has completely copied to a new location. Humans can't compare the binary data (which could be millions of values to compare) of two files to ensure they are correct. They can, however, compare two-fixed length values - such as the 12 character length output of the algorithm specified above. In the real-world, some popular algorithms are SHA1, SHA-256 and in some cases, SHA-512, where the output length of each algorithm is varied based on its security.

We'll visualise how hashing algorithms work below:

See in the png image how the contents of the first two files are the same with "TryHackMe". When using the same algorithm, the generated checksum is the same. This is because the binary data of these two files are identical, so the same algorithm will output the same result. This is not a hash collision.

Notice the third file with the same contents of "TryHackMe" resulting in the same binary data has a different checksum. This is because the algorithm, in this case, SHA256 instead of the previous MD5, uses different mathematical operations. The mathematics behind this algorithm is complex in comparison to MD5, so the length of the output string is longer.

Finally, notice in the last file in the screenshot above, that the contents of the file are now "TryHackeM" and not "TryHackMe":

Whilst the same algorithm used on the first two files are also used on this file (MD5) because the contents are now different - albeit very similar - the output is now different in comparison.


Visualising Hash Collisions:
	
Okay, bear with me here. It's been pretty theory-heavy I understand...We're almost there I promise! The example screenshots below outline how the various outputs will differ based upon either the algorithm used or the contents of the file. Here we will go through an example of a hash collision:

See the image hashcollision.png

----------------------------------------------------------------------------------------------------------------------

ONLINE SANDBOXING:

Sometimes things are left best to the experts. That's especially true in the case of malware analysis. However, online sandboxing hosts use to a wider audience than just hobbyists.

In the context of information security, sandboxing is the technique used to isolate processes to prevent direct interaction with one another. There are many examples of this. For example, using Virtualbox as a Hypervisor to run the Kali Linux operating system virtually, in parallel on your main computer. The processes within Kali Linux interact only through the means of Virtualbox and has no interference with processes on your main operating system, such as Windows.

In a malware analysis context, analysts employ virtual environments - such as those on TryHackMe, to facilitate analysis of potentially malicious code more securely.

Now, with this being said, malware has been known and can very well escape this virtual environment onto the analyst's host system. Whilst this risk is somewhat limited to sophisticated malware, it's very achievable. For example, CVE-2018-2689 is a CVE for Virtualbox where malware was capable of escaping this restricted virtual environment. CVE's such as these are extremely valuable and seldom disclosed due to the actors who discover them and their intentions, namely malicious malware authors.

CVE-Link:
	https://nvd.nist.gov/vuln/detail/CVE-2018-2689

What should be taken away from this task is that a virtual environment alone does not protect you from malware. Simply, virtual environments merely provide a convenient platform to analyse code.

Simply, an online sandbox is this virtual environment - but placed online by services such as:

    any.run - https://any.run/
    hybrid-analysis - https://hybrid-analysis.com/

These services are fantastic, as it allows hobbyists to begin understanding how malware behaves with no detriment or risk to themselves. Moreover, online sandboxing platforms are highly sophisticated and are likely to report behaviours that an analyst may have missed.

 

With this said, automated analysis cannot replace the skill and depth that an analyst can exhibit and traverse too. For example, reverse engineering. These platforms are only capable of executing malware and generating reports based upon interactions made with the operating system, any communication attempts and any signatures left behind. For example:

 

    Contacting a domain name (DNS Lookups, etc)
    Creating registry keys
    Read/Writing files
    Creating system processes
    Maintaining persistent through system startup entries

All of which are all discoverable by an analyst after some time. Therefore, online sandboxes are useful for a precursory inspection of a file.


Interacting with an online sandboxing Service:


In the example hybridAnalysis.png, this sample was run through the hybrid-analysis service. The sample took a total of 10 minutes and was free of charge. The report detailed an extensive number of behaviours such as networking traffic and the execution chain, this would have taken an analyst a considerable amount of time to of detailed themselves.

Note how the file is still identified only by its "Checksums", see image checksums.png:

If an analyst was to now search google with any of these checksums, the report generated by this sandboxing engine will now be provided as a listing for future analysts.

Proceeding to read through the report, interesting behaviours are summarised such as those below:

See images for registry and network activities.

To answer this section visit link:
	https://any.run/report/c378387344e0a552dc065de6bfa607fd26e0b5c569751c79fbf9c6f2e91c9807/3363fde4-111b-4aaa-b73d-e4144433c284

-------------------------------------------------------------------------------------------------------------------------

Calculating Hashes:
	
Using third party tools like 'Hash Tab':

1. Right-click the file you wish to retrieve the checksum of. I will be using "ComplexCalculatorv2" in this example.

2. Left-click the "Properties" title in the drop-down.

3. In the popup, navigate to the "File Hashes" tab, where you will see a screenshot akin to the one below. Note that this tab is not present on a default Windows installation:


Using windows powershell:

1. Firstly we will need to open up "Powershell". You can do this opening the Windows Search bar.
2. Next, change the directory the users Desktop by using cd Desktop 
3. Verify you are in the right directory by using dir to list the files in the directory. You should see the three below:

Powershell has both CertUtil and File-Hash commands that allow us to retrieve various checksums of files, including MD5, SHA1, SHA2, and SHA-256. I will detail the syntax for both below, calculating the MD5 checksum of a file.

Using CertUtil :
CertUtil -hashfile ComplexCalculatorv2.exe MD5|SHA256|SHA512 or "CertUtil -hashfile <filename> <algorithm>"

Using FileHash :
Get-FileHash file_name -Algorithm MD5|SHA256|SHA512

Answers :
	MD5 hash for LoginForm.exe : FF395A6D528DC5724BCDE9C844A0EE89
	SHA256 for TryHackMe.exe : 6F870C80361062E8631282D31A16872835F7962222457730BC55676A61AD1EE0
	Command for Certutil : CertUtil -hashfile TryHackMe.exe SHA256
	Command for Get-FileHash : Get-FileHash TryHackMe.exe -Algorithm SHA256

-----------------------------------------------------------------------------------------------------------------------------

VirusTotal:

Another online service that utilises these checksums is Virustotal. Virustotal acts as an indexer and aggregator for various Anti Virus (AV) engines. When a checksum is submitted to Virsutotal, fellow malware analysts can view the AV reports attributed to that file. 

Much like a search engine, you can search for reports by a few characteristics, for example:

    The IP Addresses that samples communicate with
    Checksums
    The file itself

 

In the image virusTotal.png, I have uploaded the "TryHackMe.exe" executable to Virustotal. If you were to browse to VirusTotal, you would be able to discover this report by entering the files' checksum. I have provided the report for you here.
report Link :
	https://www.virustotal.com/gui/file/6f870c80361062e8631282d31a16872835f7962222457730bc55676a61ad1ee0/details

-------------------------------------------------------------------------------------------------------------------------

Future Readings :

Cryptography and Checksums:

A Meaningful MD5 Hash Collision Attack - (Narayana D. Kashyap., 2008)
	https://scholarworks.sjsu.edu/cgi/viewcontent.cgi?referer=https://www.google.com/&httpsredir=1&article=1020&context=etd_projects


Cryptography & Network Security - (Behrouz A. Forozuan., 2007)
	https://dl.acm.org/doi/book/10.5555/1209579


The first collision for full SHA-1 - (Stevens et al., 2017) / (Shattered.io)
	https://shattered.io/static/shattered.pdf

Blogs

So you want to analyse malware?
	https://blog.cmnatic.co.uk/posts/so-you-want-to-analyse-malware/

Sandboxing Engines:

any.run

hybrid-analysis

----------------------------------------------------------------------------------------------------------------

Final Flag : THM{TryHackMe_Malware_Series_Research_Flag}

!!!
